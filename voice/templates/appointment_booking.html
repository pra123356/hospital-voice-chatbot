<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patient Registration</title>
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: linear-gradient(270deg, #c2d1d3, #e7ebf1, #e5edb6, #d0d3d6);
      background-size: 800% 800%;
      animation: gradientBG 30s ease infinite;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .container {
      display: flex;
      width: 900px;
      max-width: 100%;
      min-height: 600px;
      border-radius: 10px;
      overflow: hidden;
      background: white;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .left-side {
      flex: 1;
      background: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .left-side img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .right-side {
      flex: 1;
      padding: 25px;
      background-color: #ffffff;
      border-radius: 0 10px 10px 0;
      box-sizing: border-box;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .right-side h2 {
      text-align: center;
      color: #007acc;
      margin-top: 0;
      margin-bottom: 20px;
    }
    form { display: flex; flex-direction: column; }
    label { display: block; margin-top: 15px; font-weight: bold; color: #000; }
    input[type="text"], input[type="email"], textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
    textarea { resize: vertical; }
    button {
      margin-top: 20px;
      padding: 10px;
      width: 100%;
      background-color: #081e03;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #005f99; }
    @media (max-width: 900px) {
      .container { flex-direction: column; height: auto; width: 100%; max-width: 450px; border-radius: 10px; overflow: visible; }
      .left-side { height: 180px; }
      .right-side { padding: 20px; border-radius: 0 0 10px 10px; }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <div class="left-side" aria-hidden="true">
      <img src="/static/images/hospital.png" alt="Medical illustration" />
    </div>
    <div class="right-side">
      <h2>Patient Registration Form</h2>
      <form id="patientForm" action="http://127.0.0.1:5000/submit.html" method="POST">
        <label for="name">Full Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="phone">Phone Number:</label>
        <input type="text" id="phone" name="phone" required>

        <label for="aadhar">Aadhar Number:</label>
        <input type="text" id="aadhar" name="aadhar" required>
        
        <label for="email">Email Address:</label>
        <input type="email" id="email" name="email" required>

        <label for="gender">Gender:</label>
        <input type="text" id="gender" name="gender" placeholder="Male/Female/Other" required>

        <label for="age">Age:</label>
        <input type="text" id="age" name="age" required>


        <label for="address">Address:</label>
        <textarea id="address" name="address" rows="4" required></textarea>

        <input type="hidden" name="doctor_id" value="{{ selected_doctor_id }}">


        <button type="submit">Submit</button>
      </form>
    </div>
  </div>

<script>

const fields = [
  { id: 'name', prompt: 'Please say your full name', validate: val => val.trim().length > 3 },
  { id: 'phone', prompt: 'Please say your 10-digit phone number', validate: val => /^\d{10}$/.test(val.replace(/\D/g,'')) },
  { id: 'aadhar', prompt: 'Please say your 12-digit Aadhar number', validate: val => /^\d{12}$/.test(val.replace(/\D/g,'')) },
  { id: 'email', prompt: 'Please say your email address', validate: val => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val.trim()) },
  { id: 'gender', prompt: 'Please say your gender: Male, Female, or Other', validate: val => /^(Male|Female|Other)$/i.test(val) },
  { id: 'age', prompt: 'Please say your age', validate: val => /^\d{1,3}$/.test(val.trim()) },
  { id: 'address', prompt: 'Please say your full address', validate: val => val.trim().length > 5 }
];

const synth = window.speechSynthesis;
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
let selectedVoice = null;

function loadIndianVoice() {
  return new Promise(resolve => {
    const voices = synth.getVoices();
    const indianVoice = voices.find(v => v.name.includes("Google हिन्दी") || v.lang === "en-IN");
    if (indianVoice) { selectedVoice = indianVoice; resolve(); } else { setTimeout(() => resolve(loadIndianVoice()), 200); }
  });
}

function speak(text) {
  return new Promise(resolve => {
    synth.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-IN';
    if (selectedVoice) utterance.voice = selectedVoice;
    utterance.onend = resolve;
    synth.speak(utterance);
  });
}

function startListening(timeout = 25000) {
  return new Promise((resolve, reject) => {
    let timer;
    recognition.onresult = event => { clearTimeout(timer); resolve(event.results[0][0].transcript); };
    recognition.onerror = event => { clearTimeout(timer); reject(event.error); };
    recognition.onend = () => { clearTimeout(timer); reject('Speech recognition ended without result'); };
    recognition.start();
    timer = setTimeout(() => recognition.stop(), timeout);
  });
}

function normalizeNumberInput(text) { return text.replace(/\D/g, ''); }

async function fillFormWithVoice() {
  for (let field of fields) {
    let success = false;
    while (!success) {
      try {
        await speak(field.prompt);
        let spoken = await startListening(25000);

        if (field.id === 'email') spoken = spoken.toLowerCase().replace(/\s+dot\s+/g,'.').replace(/\s+/g,'');
        if (field.id === 'phone' || field.id === 'aadhar') spoken = normalizeNumberInput(spoken);
        if (field.id === 'gender') {
          let normalized = spoken.toLowerCase().trim();
          if (normalized.includes('male')) spoken = 'Male';
          else if (normalized.includes('female')) spoken = 'Female';
          else if (normalized.includes('other')) spoken = 'Other';
          else { spoken = ''; }
        }

        if (field.validate(spoken)) {
          document.getElementById(field.id).value = spoken;
          success = true;
        } else { await speak("The input seems invalid. Please try again."); }
      } catch { await speak("Sorry, I did not catch that. Let's try again."); }
    }
  }

  await speak("All fields are filled. Do you want to submit the form? Please say yes or no.");
  try {
    const confirmation = await startListening(15000);
    if (confirmation.toLowerCase().includes('yes')) {
      await speak("Next, let us confirm your payment and booking.");
      setTimeout(() => {
        window.location.href = "payment.html";
      }, 1000);
    }
  } catch { await speak("No confirmation received. Form submission cancelled."); }
}

window.addEventListener('DOMContentLoaded', async () => {
  const overlay = document.createElement('div');
  overlay.style.cssText = `position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); color:white; font-size:24px; display:flex; align-items:center; justify-content:center; z-index:9999; cursor:pointer;`;
  overlay.textContent = 'Click anywhere to start voice input';
  document.body.appendChild(overlay);

  recognition = new SpeechRecognition();
  recognition.lang = 'en-IN';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  await loadIndianVoice();

  const startOnce = async () => {
    document.body.removeEventListener('click', startOnce);
    document.body.removeChild(overlay);
    await speak("Welcome to the patient registration. Let us begin.");
    await fillFormWithVoice();
  };

  document.body.addEventListener('click', startOnce);
});

// ✅ NEW: Redirect to payment.html on form submit
//document.getElementById("patientForm").addEventListener("submit", function(event) {
  //event.preventDefault(); 
  //window.location.href = "payment.html";
//});
</script>
</body>
</html>
